{% extends 'base.html' %}
{% load static %}
{% block content %}

<script>
  function setThumbnail(event) {
    var imageContainer = document.querySelector("div#image_container");
    imageContainer.innerHTML = '';

    for (var image of event.target.files) {
      var reader = new FileReader();

      reader.onload = function(event) {
        var img = document.createElement("img");
        img.setAttribute("src", event.target.result);
        img.style.width = '150px';
        img.style.height = '150px';
        document.querySelector("div#image_container").appendChild(img);
      };
      console.log(image);
      reader.readAsDataURL(image);
    }
}
</script>
<main style="margin-top:100px;">
    <div style="margin: 100px;">
      <h1 class="display-4" style="margin-bottom: 50px;">파일 업로드하기</h1><hr>
        <!--action='chat'넣어주기-->
        {% csrf_token %}
        <div style="display: flex; flex-direction: row;">
          <input class="form-control border" name="file" type="file" id="formFileMultiple" multiple onchange="setThumbnail(event);" style="width:95%; display: inline; box-shadow: none;"/>
          <input id='send-button' type="submit" class="btn btn-success" value="전송" style="margin-left: 15px;"/>
        </div>
        <div id="image_container" style="text-align: center; margin-top: 100px;"></div>
        <div class="d-flex justify-content-center" style="margin-top: 40px;">
          <div id='loading'  style="display:none;" class="spinner-border text-primary" role="status">
            <span class="sr-only"></span>
          </div>
        </div>
        <div class="display-6">결과</div><hr>
        <div>
            <div style="margin-bottom: 10px;">
                <div>질문</div>
                <input style="margin-top: 10px; height: 150px; box-shadow: none;" id="question" class="form-control border" type="text" aria-label="readonly input example" readonly>
            </div>
            <div style="margin-bottom: 10px;">
                <div >답</div>
                <textarea style="word-wrap: break-word; margin-top: 10px; height: 150px; box-shadow: none;" id="chatgptanswer" class="form-control border" type="text" aria-label="readonly input example" readonly></textarea>
            </div>

        </div>
    </div>
</main>
<hr>
<script>
$.ajaxSetup({
    headers: { "X-CSRFToken": '{{csrf_token}}' }
  });

 $('#send-button').click(function(){
            $('#loading').show();
            let fd = new FormData();
            var files=$('input[name="file"]')[0].files;

            for(var i= 0; i<files.length; i++){
                fd.append('file',files[i]);
            }

            $.ajax({
                url : '/signlanguagetochatgpt/chat',
                data : fd,
                method : 'POST',
                processData : false,
                contentType : false,
                success  : function(result){
                    $('#loading').hide();
                    $('#question').val(result.question);
                    $('#chatgptanswer').val(result.result);
                    console.log(result.question);
                    console.log(result.result);
                    console.log('성공');
                    $('#image-contianer').val("")
                },
                error : function(request, status, error){
                    console.log('에러');
                    console.log("=================");
                    console.log(request);
                    console.log(status);
                    console.log(error);
                    console.log("=================");
                },
                complete : function(result){
                    console.log('완료');
                    console.log(result);

                }
            });
        });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
{% endblock content %}
